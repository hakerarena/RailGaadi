<div class="advanced-search-results-page">
  <!-- Page Header with Search Summary -->
  <app-page-header
    [title]="constants.SEARCH_RESULTS.AVAILABLE_TRAINS + ' - Advanced'"
    [icon]="'advanced_search'"
    [backgroundGradient]="true"
    (newSearch)="onNewSearch()"
    [additionalContent]="searchSummaryTemplate"
  >
  </app-page-header>

  <!-- Search Summary Template -->
  <ng-template #searchSummaryTemplate>
    <app-search-summary
      *ngIf="searchCriteria"
      [searchCriteria]="searchCriteria"
      [additionalFeatures]="advancedFeaturesTemplate"
    >
    </app-search-summary>

    <!-- Advanced Features Template -->
    <ng-template #advancedFeaturesTemplate>
      <div class="advanced-features">
        <mat-chip-set>
          <mat-chip color="accent" selected>
            <mat-icon matChipAvatar>search</mat-icon>
            Advanced Search
          </mat-chip>
          <mat-chip *ngIf="hasPartialJourneys" color="primary">
            <mat-icon matChipAvatar>alt_route</mat-icon>
            Partial Journey Options
          </mat-chip>
        </mat-chip-set>
      </div>
    </ng-template>
  </ng-template>

  <!-- Loading State -->
  <div class="loading-section" *ngIf="isSearching">
    <app-loading-spinner
      message="Searching trains and analyzing routes..."
      size="large"
    >
    </app-loading-spinner>
  </div>

  <!-- Search Results Tabs -->
  <div class="results-section" *ngIf="showResults">
    <div class="container">
      <mat-tab-group [(selectedIndex)]="activeTab" class="results-tabs">
        <!-- Direct Trains Tab -->
        <mat-tab [label]="'Direct Trains (' + searchResults.length + ')'">
          <div class="tab-content" *ngIf="hasDirectTrains">
            <div class="section-header">
              <h2>Direct Trains</h2>
              <p>Trains running directly between your selected stations</p>
            </div>
            <app-train-search-results
              [searchResults]="searchResults"
              [isFlexibleSearch]="searchCriteria?.flexibleWithDate || false"
              [searchDate]="searchCriteria?.journeyDate || null"
            >
            </app-train-search-results>
          </div>
          <app-no-results
            *ngIf="!hasDirectTrains"
            title="No Direct Trains Found"
            message="No direct trains available for this route. Check partial journey options below."
            icon="train"
            [showActionButton]="false"
          >
          </app-no-results>
        </mat-tab>

        <!-- Partial Journey Options Tab -->
        <mat-tab
          [label]="
            'Partial Journey Options (' + partialJourneyResults.length + ')'
          "
        >
          <div class="tab-content" *ngIf="hasPartialJourneys">
            <div class="section-header">
              <h2>Partial Journey Options</h2>
              <p>
                Alternative routes with confirmed tickets for partial segments
              </p>
              <div class="info-card">
                <mat-icon class="info-icon">info</mat-icon>
                <span
                  >These options show confirmed tickets available for parts of
                  your journey. You may need to book multiple tickets.</span
                >
              </div>
            </div>

            <div class="partial-journeys-list">
              <mat-expansion-panel
                *ngFor="
                  let partialJourney of partialJourneyResults;
                  let i = index
                "
                class="partial-journey-panel"
                [expanded]="i === 0"
              >
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <div class="journey-title">
                      <div class="route-info">
                        <span class="route">
                          {{ partialJourney.fromStation.name }} →
                          {{ partialJourney.toStation.name }}
                        </span>
                        <mat-chip class="transfer-chip">
                          {{ partialJourney.transferCount }} Transfer{{
                            partialJourney.transferCount > 1 ? "s" : ""
                          }}
                        </mat-chip>
                      </div>
                      <div class="timing-info">
                        <span class="time"
                          >{{ partialJourney.departureTime }} -
                          {{ partialJourney.arrivalTime }}</span
                        >
                        <span class="duration">{{
                          partialJourney.totalDuration
                        }}</span>
                      </div>
                    </div>
                  </mat-panel-title>
                  <mat-panel-description>
                    <div class="classes-info">
                      <span
                        *ngFor="
                          let cls of partialJourney.availableClasses;
                          let last = last
                        "
                      >
                        {{ cls }}<span *ngIf="!last">, </span>
                      </span>
                    </div>
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <!-- Journey Details -->
                <div class="journey-details">
                  <div class="route-segments">
                    <div
                      *ngFor="
                        let segment of partialJourney.routeSegments;
                        let i = index;
                        let last = last
                      "
                      class="segment"
                    >
                      <!-- Train Segment -->
                      <div class="train-segment">
                        <div class="segment-header">
                          <div class="train-info">
                            <mat-icon class="segment-icon">train</mat-icon>
                            <div class="train-details">
                              <h4>
                                {{ segment.train.trainName }} ({{
                                  segment.train.trainNumber
                                }})
                              </h4>
                              <p class="segment-route">
                                {{ segment.fromStation.name }} →
                                {{ segment.toStation.name }}
                              </p>
                            </div>
                          </div>
                          <div class="timing">
                            <div class="time-slot">
                              <span class="time">{{
                                segment.departureTime
                              }}</span>
                              <span class="station">{{
                                segment.fromStation.code
                              }}</span>
                            </div>
                            <div class="duration-indicator">
                              <mat-icon>schedule</mat-icon>
                              <span>{{ segment.duration }}</span>
                            </div>
                            <div class="time-slot">
                              <span class="time">{{
                                segment.arrivalTime
                              }}</span>
                              <span class="station">{{
                                segment.toStation.code
                              }}</span>
                            </div>
                          </div>
                        </div>

                        <div class="classes-availability">
                          <div class="available-classes">
                            <span class="label">Available Classes:</span>
                            <mat-chip-set>
                              <mat-chip
                                *ngFor="let cls of segment.availableClasses"
                              >
                                {{ cls }}
                              </mat-chip>
                            </mat-chip-set>
                          </div>
                        </div>
                      </div>

                      <!-- Transfer Information -->
                      <div
                        class="transfer-info"
                        *ngIf="segment.isTransfer && !last"
                      >
                        <div class="transfer-details">
                          <mat-icon class="transfer-icon"
                            >transfer_within_a_station</mat-icon
                          >
                          <div class="transfer-text">
                            <strong
                              >Transfer at {{ segment.toStation.name }}</strong
                            >
                            <p>
                              Minimum transfer time: {{ segment.transferTime }}
                            </p>
                          </div>
                        </div>
                      </div>

                      <!-- Connector Line -->
                      <div class="connector" *ngIf="!last"></div>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="journey-actions">
                    <app-action-button
                      variant="raised"
                      color="primary"
                      (click)="onBookPartialJourney(partialJourney)"
                      icon="book_online"
                      text="Book This Journey"
                      class="book-journey-btn"
                    >
                    </app-action-button>

                    <app-action-button
                      variant="basic"
                      color="accent"
                      icon="info"
                      text="More Details"
                      class="journey-info-btn"
                    >
                    </app-action-button>
                  </div>
                </div>
              </mat-expansion-panel>
            </div>
          </div>

          <app-no-results
            *ngIf="!hasPartialJourneys"
            title="No Partial Journey Options Found"
            message="No alternative routes with confirmed ticket availability found for this route."
            icon="alt_route"
            [showActionButton]="false"
          >
          </app-no-results>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>

  <!-- No Results Message -->
  <div class="no-results-section" *ngIf="showNoResults">
    <div class="container">
      <app-no-results
        [title]="constants.SEARCH_RESULTS.NO_TRAINS_FOUND"
        message="Sorry, no trains or alternative routes were found for the selected criteria."
        icon="search_off"
        [showSuggestions]="true"
        [suggestions]="[
          'Search for different dates',
          'Check nearby stations',
          'Try different travel classes',
          'Enable flexible date search'
        ]"
        [actionButtonText]="constants.BUTTONS.TRY_DIFFERENT_SEARCH"
        (actionButtonClick)="onNewSearch()"
      >
      </app-no-results>
    </div>
  </div>
</div>
