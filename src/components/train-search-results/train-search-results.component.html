@if (searchResults && searchResults.length > 0) {
<div class="results-container">
  <div class="results-header">
    <!-- <h2>Available Trains</h2> -->
    <div class="filter-options">
      <mat-form-field appearance="outline" class="sort-field">
        <mat-label>Sort By</mat-label>
        <mat-select [(value)]="sortBy" (selectionChange)="onSort(sortBy)">
          <mat-option value="departure">Departure Time</mat-option>
          <mat-option value="duration">Duration</mat-option>
          <mat-option value="fare">Fare</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <div class="train-cards">
    @for (train of dataSource.data; track train.trainNumber) {
    <mat-card class="train-card">
      <mat-card-header>
        <div class="train-header">
          <div class="train-basic-info">
            <h3>{{ train.trainNumber }} · {{ train.trainName }}</h3>
            <div class="running-days">
              Runs on: @for (day of train.runningDays; track day) {
              <span [class.active]="day" class="day-indicator">
                {{ day }}
              </span>
              }
            </div>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="journey-info">
          <div class="time-info departure">
            <div class="time">{{ train.departureTime }}</div>
            <div class="station">{{ train.source }}</div>
            <div class="date">Day 1</div>
          </div>

          <div class="journey-duration">
            <div class="duration-line">
              <mat-icon>arrow_forward</mat-icon>
            </div>
            <div class="duration-text">{{ train.duration }}</div>
          </div>

          <div class="time-info arrival">
            <div class="time">{{ train.arrivalTime }}</div>
            <div class="station">{{ train.destination }}</div>
            <div class="date">
              Day {{ getDayDifference(train.departureTime, train.arrivalTime) }}
            </div>
          </div>
        </div>

        <div class="class-availability">
          <!-- Show flexible date options if enabled -->
          <div
            *ngIf="
              isFlexibleSearch && getAvailableDatesForTrain(train).length > 0
            "
            class="flexible-dates"
          >
            <h4>Available Dates</h4>
            <div class="date-carousel-container">
              <button
                class="carousel-arrow left-arrow"
                (click)="scrollLeft(train.trainNumber)"
                [disabled]="!canScrollLeft(train.trainNumber)"
                mat-icon-button
              >
                <mat-icon>chevron_left</mat-icon>
              </button>

              <div
                class="date-carousel"
                #dateCarousel
                [attr.data-train]="train.trainNumber"
              >
                @if (getCurrentSelectedDate(train); as selectedDate) {
                <div
                  class="date-option"
                  [class]="getAnimationState(train.trainNumber)"
                >
                  <div class="date-header">
                    <span class="date-label">{{
                      formatDate(selectedDate)
                    }}</span>
                    <span class="date-full">{{
                      selectedDate.toDateString()
                    }}</span>
                  </div>
                  <div class="class-grid">
                    @for (class of getClassAvailabilityForDate(train,
                    selectedDate); track class.code) {
                    <div class="class-card">
                      <div class="class-header">
                        <span class="class-name">{{ class.name }}</span>
                        <span class="class-code">({{ class.code }})</span>
                      </div>
                      <div
                        class="availability"
                        [class.available]="class.availableSeats > 0"
                      >
                        {{
                          class.availableSeats > 0
                            ? class.availableSeats + " seats"
                            : "Waiting List"
                        }}
                      </div>
                      <div class="fare">₹{{ class.fare }}</div>
                      <button
                        mat-stroked-button
                        color="primary"
                        class="book-button"
                        (click)="onBookNow(train, class)"
                        [disabled]="class.availableSeats === 0"
                      >
                        {{
                          class.availableSeats === 0 ? "Waitlist" : "Book Now"
                        }}
                      </button>
                    </div>
                    }
                  </div>
                </div>
                }
              </div>

              <button
                class="carousel-arrow right-arrow"
                (click)="scrollRight(train.trainNumber)"
                [disabled]="!canScrollRight(train.trainNumber)"
                mat-icon-button
              >
                <mat-icon>chevron_right</mat-icon>
              </button>
            </div>
          </div>

          <!-- Regular class availability for non-flexible search -->
          @if (!isFlexibleSearch) {
          <div class="regular-classes">
            @for (class of train.availableClasses; track class.code) {
            <div class="class-card">
              <div class="class-header">
                <span class="class-name">{{ class.name }}</span>
                <span class="class-code">({{ class.code }})</span>
              </div>
              <div
                class="availability"
                [class.available]="class.availableSeats > 0"
              >
                {{
                  class.availableSeats > 0
                    ? class.availableSeats + " seats"
                    : "Waiting List"
                }}
              </div>
              <div class="fare">₹{{ class.fare }}</div>
              <button
                mat-stroked-button
                color="primary"
                class="book-button"
                (click)="onBookNow(train, class)"
                [disabled]="class.availableSeats === 0"
              >
                {{ class.availableSeats === 0 ? "Waitlist" : "Book Now" }}
              </button>
            </div>
            }
          </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
    }
  </div>

  <mat-paginator
    [pageSizeOptions]="[5, 10, 25]"
    [pageSize]="10"
    aria-label="Select page of trains"
  ></mat-paginator>
</div>
} @if (searchResults && searchResults.length === 0) {
<div class="no-results">
  <mat-icon>train</mat-icon>
  <h3>No trains found for this route</h3>
  <p>Try searching with different dates or stations</p>
</div>
} @if (searchResults?.length === 0) {
<div class="no-results">
  <p>No trains found for the selected route.</p>
</div>
}
